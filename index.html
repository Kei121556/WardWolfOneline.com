<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Wolf Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7c3aed; /* Violet */
            --danger-color: #dc2626; /* Red */
            --background-color: #111827; /* Gray 900 */
            --card-bg: #1f2937; /* Gray 800 */
            --text-color: #f9fafb; /* Gray 50 */
            --border-color: #374151; /* Gray 700 */
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overscroll-behavior: none;
        }
        .screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
            transition: opacity 0.5s ease-in-out;
        }
        .screen.hidden { display: none; }
        .card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600;
            text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; border: none;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #6d28d9; }
        .form-input {
            width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.5rem;
            background-color: #374151; border: 1px solid #4b5563; color: white;
        }
    </style>
</head>
<body>
    <!-- App Container -->
    <div id="app-container">
        <!-- All screens will be rendered here by JavaScript -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // =================================================================================
        // STEP 1: Firebase„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        // =================================================================================
        // „Åì„Åì„Å´„ÄÅ„ÅÇ„Å™„Åü„ÅÆFirebase„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË®≠ÂÆöÊÉÖÂ†±„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // =================================================================================

        // Firebase„ÅÆÊ©üËÉΩ„Çí„Ç§„É≥„Éù„Éº„Éà
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Firebase„ÇíÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let localState = {
            userId: null,
            playerName: localStorage.getItem('playerName') || '',
            roomId: null,
            isHost: false,
            roomUnsubscribe: null,
        };

        const appContainer = document.getElementById('app-container');

        // --- UI Rendering Engine ---
        function render(html) {
            appContainer.innerHTML = html;
        }

        // --- All Game Screens (Templates) ---

        function getHomeScreenHTML() {
            return `
                <div class="screen">
                    <div class="card text-center">
                        <h1 class="text-4xl font-bold text-violet-400">Word Wolf</h1>
                        <p class="text-gray-400 mt-2 mb-8">The Ultimate Word Finding Game</p>
                        <div class="space-y-4">
                            <input type="text" id="player-name-input" class="form-input text-center" placeholder="Enter your name" value="${localState.playerName}">
                            <button id="create-room-btn" class="btn btn-primary w-full">Create Room</button>
                            <div class="flex items-center gap-2">
                                <input type="text" id="join-room-id-input" class="form-input text-center" placeholder="Room ID">
                                <button id="join-room-btn" class="btn btn-secondary">Join</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getWaitingRoomHTML(room) {
            const me = room.players[localState.userId];
            const isHost = me && me.isHost;
            const playersHTML = Object.values(room.players).map(p => `<span class="p-2 rounded-full bg-gray-700">${p.name} ${p.isHost ? 'üëë' : ''}</span>`).join('');
            
            return `
                <div class="screen">
                    <div class="card text-center">
                        <p class="text-gray-400">Room ID</p>
                        <div class="bg-gray-900 p-3 rounded-md font-mono text-2xl tracking-widest my-2 cursor-pointer" id="room-id-display">${room.id}</div>
                        <p id="copy-feedback" class="text-sm text-green-400 h-4"></p>
                        <h2 class="text-xl font-bold mt-6 mb-3">Players (${Object.keys(room.players).length})</h2>
                        <div class="flex flex-wrap justify-center gap-2 mb-6">${playersHTML}</div>
                        ${isHost ? `
                            <button id="start-game-btn" class="btn btn-primary w-full mt-6">Start Game</button>
                        ` : '<p class="text-gray-400 mt-6">Waiting for the host to start the game...</p>'}
                    </div>
                </div>
            `;
        }
        
        // --- Firebase Logic ---

        async function createRoom() {
            if (!validatePlayerName()) return;
            localState.isHost = true;
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const roomRef = doc(db, "rooms", roomId);

            const newPlayer = {
                [localState.userId]: {
                    name: localState.playerName,
                    isHost: true,
                }
            };

            await setDoc(roomRef, {
                id: roomId,
                hostId: localState.userId,
                gameState: 'waiting',
                players: newPlayer,
            });
            
            joinRoom(roomId);
        }

        async function joinRoom(roomId) {
            if (!roomId || !validatePlayerName()) return;
            
            const roomRef = doc(db, "rooms", roomId);
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) {
                alert("Room not found!");
                return;
            }

            const newPlayerData = {
                name: localState.playerName,
                isHost: roomSnap.data().hostId === localState.userId,
            };
            await updateDoc(roomRef, {
                [`players.${localState.userId}`]: newPlayerData
            });

            if (localState.roomUnsubscribe) localState.roomUnsubscribe();
            localState.roomUnsubscribe = onSnapshot(roomRef, (doc) => {
                const roomData = doc.data();
                if (roomData) {
                    if (roomData.gameState === 'waiting') {
                        render(getWaitingRoomHTML(roomData));
                        addWaitingRoomListeners(roomData);
                    }
                } else {
                    alert("The room has been closed.");
                    if(localState.roomUnsubscribe) localState.roomUnsubscribe();
                    render(getHomeScreenHTML());
                    addHomeListeners();
                }
            });
        }

        function validatePlayerName() {
            const nameInput = document.getElementById('player-name-input');
            const playerName = nameInput.value.trim();
            if (!playerName) {
                alert('Please enter your name.');
                return false;
            }
            localState.playerName = playerName;
            localStorage.setItem('playerName', playerName);
            return true;
        }

        // --- Event Listeners ---
        
        function addHomeListeners() {
            document.getElementById('create-room-btn').addEventListener('click', createRoom);
            document.getElementById('join-room-btn').addEventListener('click', () => {
                const roomId = document.getElementById('join-room-id-input').value.trim().toUpperCase();
                joinRoom(roomId);
            });
        }

        function addWaitingRoomListeners(room) {
            if (room.hostId === localState.userId) {
                document.getElementById('start-game-btn').addEventListener('click', async () => {
                    const roomRef = doc(db, "rooms", room.id);
                    await updateDoc(roomRef, { gameState: 'role_assignment' });
                });
            }
            document.getElementById('room-id-display').addEventListener('click', (e) => {
                navigator.clipboard.writeText(room.id);
                const feedback = document.getElementById('copy-feedback');
                feedback.textContent = 'Copied!';
                setTimeout(() => feedback.textContent = '', 2000);
            });
        }

        // --- Initial Load ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                localState.userId = user.uid;
                render(getHomeScreenHTML());
                addHomeListeners();
            } else {
                signInAnonymously(auth);
            }
        });
    </script>
</body>
</html>
